name: Deploy to Gigalixir

on:
  schedule:
    - cron: '0 */23 * * *'
  workflow_dispatch:
    inputs:
      deploy_reason:
        description: 'gengxindaima'
        required: false
        default: 'shoudongbushu'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Git
      run: |
        git config --global user.email "glade@outlook.com"
        git config --global user.name "glade"
        
    - name: Deploy to Gigalixir
      env:
        GIGALIXIR_EMAIL: ${{ secrets.GIGALIXIR_EMAIL }}
        GIGALIXIR_PASSWORD: ${{ secrets.GIGALIXIR_PASSWORD }}
        GIGALIXIR_APP_NAME: ${{ secrets.GIGALIXIR_APP_NAME }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $(date)"
        
        # å®‰è£… Gigalixir CLI
        pip3 install gigalixir
        
        # ç¡®ä¿å¼€å§‹æ—¶æ²¡æœ‰é—ç•™çš„ .netrc æ–‡ä»¶
        rm -f ~/.netrc
        
        # ç™»å½• Gigalixir
        gigalixir login -e "$GIGALIXIR_EMAIL" -p "$GIGALIXIR_PASSWORD" -y
        
        # åˆå§‹åŒ–å¹¶éƒ¨ç½²
        git init
        git add index.js package.json apps.html
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          git commit -m "Manual deployment - ${{ github.event.inputs.deploy_reason }} - $(date)"
        else
          git commit -m "Scheduled deployment - $(date)"
        fi
        
        git remote add gigalixir "https://git.gigalixir.com/${GIGALIXIR_APP_NAME}.git"
        git push gigalixir main --force
        
        echo "âœ… éƒ¨ç½²å®Œæˆ - $(date)"
      
    - name: Cleanup credentials
      if: always()  # ç¡®ä¿æ— è®ºéƒ¨ç½²æˆåŠŸä¸å¦éƒ½æ‰§è¡Œæ¸…ç†
      run: |
        echo "ğŸ§¹ æ¸…ç†å‡­è¯..."
        if [ -f ~/.netrc ]; then
          rm -f ~/.netrc
          echo "å·²åˆ é™¤ .netrc æ–‡ä»¶"
        else
          echo ".netrc æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        # é¢å¤–æ£€æŸ¥å…¶ä»–å¯èƒ½çš„å‡­è¯æ–‡ä»¶
        rm -f ~/.gigalixir/credentials
        rm -rf ~/.gigalixir
        
        echo "âœ… å‡­è¯æ¸…ç†å®Œæˆ"

    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo "éƒ¨ç½²åº”ç”¨: ${{ secrets.GIGALIXIR_APP_NAME }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "å¤±è´¥æ—¶é—´: $(date)"
          echo "å¤±è´¥åº”ç”¨: ${{ secrets.GIGALIXIR_APP_NAME }}"
        fi
        
        # æœ€åå†æ¬¡ç¡®è®¤æ¸…ç†
        if [ -f ~/.netrc ]; then
          echo "âš ï¸ è­¦å‘Š: .netrc æ–‡ä»¶ä»ç„¶å­˜åœ¨"
          rm -f ~/.netrc
        else
          echo "âœ… ç¡®è®¤ .netrc å·²æ¸…ç†"
        fi
