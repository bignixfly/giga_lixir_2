name: Deploy to Gigalixir

on:
  schedule:
    - cron: '0 */23 * * *'
  workflow_dispatch:
    inputs:
      deploy_reason:
        description: 'gengxindaima'
        required: false
        default: 'shoudongbushu'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Git
      run: |
        git config --global user.email "glade@outlook.com"
        git config --global user.name "glade"
        
    - name: Deploy to Gigalixir
      env:
        GIGALIXIR_EMAIL: ${{ secrets.GIGALIXIR_EMAIL }}
        GIGALIXIR_PASSWORD: ${{ secrets.GIGALIXIR_PASSWORD }}
        GIGALIXIR_APP_NAME: ${{ secrets.GIGALIXIR_APP_NAME }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $(date)"
        
        # å®‰è£… Gigalixir CLI
        pip3 install gigalixir
        
        # ç¡®ä¿å¼€å§‹æ—¶æ²¡æœ‰é—ç•™çš„ .netrc æ–‡ä»¶
        rm -f ~/.netrc
        
        # ç™»å½• Gigalixir
        gigalixir login -e "$GIGALIXIR_EMAIL" -p "$GIGALIXIR_PASSWORD" -y
        
        # åˆ›å»ºæ–°çš„ä¸´æ—¶ç›®å½•å¹¶åˆå§‹åŒ–
        TEMP_DIR=$(mktemp -d)
        cd $TEMP_DIR
        
        # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp $GITHUB_WORKSPACE/index.js .
        cp $GITHUB_WORKSPACE/package.json .
        cp $GITHUB_WORKSPACE/apps.html .
        
        # åˆå§‹åŒ–æ–°çš„ git ä»“åº“
        git init
        git add index.js package.json apps.html
        
        # å¼ºåˆ¶åˆ›å»ºæäº¤ï¼Œå³ä½¿æ–‡ä»¶æ²¡æœ‰æ›´æ”¹
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          git commit --allow-empty -m "Manual deployment - ${{ github.event.inputs.deploy_reason }} - $(date)"
        else
          git commit --allow-empty -m "Scheduled deployment - $(date)"
        fi
        
        # æ·»åŠ è¿œç¨‹ä»“åº“å¹¶æ¨é€
        git remote add gigalixir "https://git.gigalixir.com/${GIGALIXIR_APP_NAME}.git"
        git push gigalixir main --force
        
        echo "âœ… éƒ¨ç½²å®Œæˆ - $(date)"
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        cd $GITHUB_WORKSPACE
        rm -rf $TEMP_DIR
      
    - name: Cleanup credentials
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†å‡­è¯..."
        if [ -f ~/.netrc ]; then
          rm -f ~/.netrc
          echo "å·²åˆ é™¤ .netrc æ–‡ä»¶"
        else
          echo ".netrc æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        rm -f ~/.gigalixir/credentials
        rm -rf ~/.gigalixir
        
        echo "âœ… å‡­è¯æ¸…ç†å®Œæˆ"

    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo "éƒ¨ç½²åº”ç”¨: ${{ secrets.GIGALIXIR_APP_NAME }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "å¤±è´¥æ—¶é—´: $(date)"
          echo "å¤±è´¥åº”ç”¨: ${{ secrets.GIGALIXIR_APP_NAME }}"
        fi
        
        if [ -f ~/.netrc ]; then
          echo "âš ï¸ è­¦å‘Š: .netrc æ–‡ä»¶ä»ç„¶å­˜åœ¨"
          rm -f ~/.netrc
        else
          echo "âœ… ç¡®è®¤ .netrc å·²æ¸…ç†"
        fi
